<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚å°å­¸å ‚ãƒ»é›²ç«¯ç›¸ç°¿ ğŸ“¸</title>
    <!-- å­—é«” Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 (æ¼‚äº®çš„æç¤ºæ¡†) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- JSZip & FileSaver (ç”¨æ–¼æ‰“åŒ…ä¸‹è¼‰) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        'kids-yellow': '#FFD93D',
                        'kids-red': '#FF6B6B',
                        'kids-blue': '#4D96FF',
                        'kids-green': '#6BCB77',
                        'kids-bg': '#F7F2E7'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F7F2E7; background-image: radial-gradient(#FFD93D 2px, transparent 2px); background-size: 30px 30px; display: flex; flex-direction: column; min-height: 100vh; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #FF6B6B; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* éš±è—å·è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ç¸®åœ–é¸ä¸­æ¨£å¼ */
        .thumb-active { border: 3px solid #FFD93D; opacity: 1 !important; transform: scale(1.05); }
        
        /* åœ–ç‰‡æ”¾å¤§æ¸¸æ¨™ */
        .cursor-zoom-in { cursor: zoom-in; }
        .cursor-zoom-out { cursor: zoom-out; }
        .cursor-crosshair { cursor: crosshair; }
    </style>
</head>
<body class="text-gray-700 font-sans">

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-white shadow-lg sticky top-0 z-50 border-b-4 border-kids-yellow">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-camera-retro text-3xl text-kids-blue"></i>
                <!-- ä¿®æ”¹ï¼šåŠ ä¸Š ID æ–¹ä¾¿ç¨‹å¼ä¿®æ”¹ -->
                <h1 id="app-header-title" class="text-xl md:text-2xl font-bold text-gray-800 tracking-wide">å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿</h1>
            </div>
            <div class="flex items-center space-x-3">
                <!-- <button onclick="openUploadModal()" class="bg-kids-green hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition shadow-md flex items-center">
                    <i class="fa-solid fa-cloud-arrow-up mr-2"></i> ä¸Šå‚³
                </button> -->
                <button onclick="openSettings()" class="bg-kids-blue hover:bg-blue-600 text-white p-2 rounded-full w-10 h-10 transition shadow-md">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <button onclick="openHelp()" class="bg-kids-red hover:bg-red-600 text-white p-2 rounded-full w-10 h-10 transition shadow-md">
                    <i class="fa-solid fa-info"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="container mx-auto px-4 py-8 flex-grow">
        
        <!-- è¼‰å…¥ä¸­å‹•ç•« -->
        <div id="loading" class="flex flex-col items-center justify-center mt-20 hidden">
            <div class="loader mb-4"></div>
            <p class="text-lg font-bold text-gray-500 animate-pulse">æ­£åœ¨å»é›²ç«¯æ¬é‹ç…§ç‰‡...</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ / æ­¡è¿ç•«é¢ -->
        <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-10 p-8 bg-white rounded-3xl shadow-xl border-4 border-dashed border-kids-yellow max-w-lg mx-auto">
            <i class="fa-solid fa-images text-6xl text-gray-300 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-700 mb-2">é‚„æ²’æœ‰çœ‹åˆ°ç›¸ç°¿å–”ï¼</h2>
            <p class="text-center text-gray-500 mb-6">è«‹å…ˆé»æ“Šå³ä¸Šè§’çš„è¨­å®š (âš™ï¸) æŒ‰éˆ•<br>è²¼ä¸Šä½ çš„ GAS ç¶²å€ä¾†é€£ç·šã€‚</p>
            <button onclick="openSettings()" class="bg-kids-yellow hover:bg-yellow-400 text-gray-800 font-bold py-2 px-6 rounded-full shadow-md transition">
                <i class="fa-solid fa-plug mr-2"></i> ç«‹å³é€£ç·š
            </button>
        </div>

        <!-- ç›¸ç°¿åˆ—è¡¨ -->
        <div id="album-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- JS å‹•æ…‹æ’å…¥ç›¸ç°¿å¡ç‰‡ -->
        </div>

    </main>

    <!-- é å°¾ (æ–°å¢) -->
    <footer class="bg-white border-t-4 border-kids-yellow py-6 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-700 font-bold mb-3 text-lg">
                Made by <a href="https://gsyan888.blogspot.com/" target="_blank" class="text-kids-blue hover:text-blue-600 transition underline decoration-2 underline-offset-2">é˜¿å‰›è€å¸«</a>
                <i class="fa-solid fa-pencil text-kids-yellow ml-1"></i>
            </p>
            <div class="flex flex-col md:flex-row justify-center items-center space-y-2 md:space-y-0 md:space-x-4 text-sm text-gray-500">
                <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" class="flex items-center hover:text-gray-700 transition group">
                    <span class="mr-2">æœ¬è‘—ä½œæ¡ç”¨</span>
                    <i class="fa-brands fa-creative-commons text-2xl group-hover:text-kids-blue transition mx-0.5"></i>
                    <i class="fa-brands fa-creative-commons-by text-2xl group-hover:text-kids-blue transition mx-0.5"></i>
                    <i class="fa-brands fa-creative-commons-nc text-2xl group-hover:text-kids-blue transition mx-0.5"></i>
                    <i class="fa-brands fa-creative-commons-sa text-2xl group-hover:text-kids-blue transition mx-0.5"></i>
                    <span class="ml-2">å‰µç”¨ CC å§“åæ¨™ç¤º-éå•†æ¥­æ€§-ç›¸åŒæ–¹å¼åˆ†äº« 4.0 åœ‹éš› æˆæ¬Šæ¢æ¬¾</span>
                </a>
            </div>
        </div>
    </footer>

    <!-- ç›¸ç‰‡ç€è¦½ Modal (ä¸Šå¤§åœ–ä¸‹ç¸®åœ–) -->
    <div id="gallery-modal" class="fixed inset-0 bg-black bg-opacity-95 z-[60] hidden flex flex-col">
        <!-- Header -->
        <div class="flex justify-between items-center p-3 text-white shrink-0 bg-gradient-to-b from-gray-900 to-transparent z-10">
            <h3 id="gallery-title" class="text-xl font-bold truncate">ç›¸ç°¿åç¨±</h3>
            <div class="flex items-center space-x-2 md:space-x-3">
                <!-- ç°¡å ±æ¨¡å¼æŒ‰éˆ• (New) -->
                <button onclick="openPresentationMode()" class="flex items-center space-x-1 bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-3 py-2 rounded-full transition shadow-lg border border-indigo-400" title="é€²å…¥ç°¡å ±ç•«ç­†æ¨¡å¼">
                    <i class="fa-solid fa-chalkboard-user"></i>
                    <span class="hidden md:inline">ç°¡å ±æ¨¡å¼</span>
                </button>
                
                <!-- ä¸‹è¼‰ ZIP æŒ‰éˆ• -->
                <button onclick="downloadAlbumZip()" class="flex items-center space-x-1 bg-gray-700 hover:bg-kids-blue text-white text-sm px-3 py-2 rounded-full transition shadow-lg border border-gray-600" title="æ‰“åŒ…ä¸‹è¼‰æ•´æœ¬ç›¸ç°¿">
                    <i class="fa-solid fa-download"></i>
                    <span class="hidden md:inline">æ‰“åŒ…ä¸‹è¼‰</span>
                </button>
                
                <button id="auto-play-btn" onclick="toggleAutoPlay()" class="flex items-center space-x-1 bg-gray-700 hover:bg-kids-yellow hover:text-gray-900 text-white text-sm px-3 py-2 rounded-full transition shadow-lg border border-gray-600">
                    <i class="fa-solid fa-play"></i>
                    <span class="hidden md:inline">è‡ªå‹•æ’­æ”¾</span>
                </button>
                
                <button onclick="closeGallery()" class="bg-gray-700 hover:bg-kids-red w-10 h-10 rounded-full flex items-center justify-center transition border border-gray-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Main View Area (Big Picture) -->
        <div class="flex-1 flex items-center justify-center overflow-hidden relative group w-full bg-black">
             <!-- å·¦å³åˆ‡æ›æŒ‰éˆ• -->
             <button onclick="prevPhoto()" class="absolute left-2 md:left-4 z-20 text-white text-2xl md:text-4xl opacity-50 group-hover:opacity-100 transition bg-black bg-opacity-40 hover:bg-opacity-70 rounded-full w-10 h-10 md:w-14 md:h-14 flex items-center justify-center focus:outline-none">â®</button>
             <button onclick="nextPhoto()" class="absolute right-2 md:right-4 z-20 text-white text-2xl md:text-4xl opacity-50 group-hover:opacity-100 transition bg-black bg-opacity-40 hover:bg-opacity-70 rounded-full w-10 h-10 md:w-14 md:h-14 flex items-center justify-center focus:outline-none">â¯</button>
             
             <!-- åœ–ç‰‡/å½±ç‰‡å®¹å™¨ -->
             <div id="main-view" class="w-full h-full flex items-center justify-center p-2">
                <!-- Main Image/Video will be injected here -->
             </div>
        </div>

        <!-- Thumbnails Strip (Bottom) -->
        <div class="h-24 md:h-28 bg-gray-900 shrink-0 flex items-center p-2 space-x-2 overflow-x-auto hide-scrollbar border-t border-gray-800 z-10" id="thumbnail-strip">
            <!-- Thumbnails injected here -->
        </div>
    </div>

    <!-- ç°¡å ±æ¨¡å¼ Modal (æ–°åŠŸèƒ½) -->
    <div id="presentation-modal" class="fixed inset-0 bg-black z-[100] hidden flex flex-col select-none touch-none">
        <!-- é ‚éƒ¨é—œé–‰æŒ‰éˆ• -->
        <div class="absolute top-4 right-4 z-[120]">
            <button onclick="closePresentationMode()" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg border-2 border-white text-xl transition transform hover:scale-110">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <!-- åœ–ç‰‡å€åŸŸ -->
        <div class="relative flex-1 flex items-center justify-center overflow-hidden w-full h-full">
            <img id="presentation-image" src="" class="max-w-full max-h-full object-contain pointer-events-none">
            <!-- ç•«å¸ƒï¼šè¦†è“‹å…¨è¢å¹•ï¼Œå…è¨±åœ¨åœ–ç‰‡å’Œé»‘é‚Šä¸Šç¹ªç•« -->
            <canvas id="drawing-canvas" class="absolute inset-0 cursor-crosshair z-[110]"></canvas>
        </div>

        <!-- å·¦å³å°èˆªæŒ‰éˆ• (æ‡¸æµ®) -->
        <button onclick="prevSlide()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white text-5xl opacity-30 hover:opacity-100 bg-gray-800 bg-opacity-30 hover:bg-opacity-70 rounded-full w-20 h-20 flex items-center justify-center z-[120] transition focus:outline-none">&lt;</button>
        <button onclick="nextSlide()" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white text-5xl opacity-30 hover:opacity-100 bg-gray-800 bg-opacity-30 hover:bg-opacity-70 rounded-full w-20 h-20 flex items-center justify-center z-[120] transition focus:outline-none">&gt;</button>

        <!-- ç•«ç­†å·¥å…·åˆ— (ä¸‹æ–¹æ‡¸æµ®) -->
        <div id="drawing-toolbar" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 bg-opacity-90 backdrop-blur-sm rounded-full p-2 flex items-center space-x-2 z-[120] shadow-2xl border border-gray-600 transition-all duration-300">
            <!-- å±•é–‹çš„å·¥å…· -->
            <div id="drawing-tools" class="flex items-center space-x-3 px-2 overflow-hidden transition-all duration-300 origin-left">
                <button class="w-10 h-10 rounded-full bg-red-500 border-2 border-white shadow-md transform hover:scale-110 active:scale-95 transition" onclick="setPenColor('#ef4444')" title="ç´…ç­†"></button>
                <button class="w-10 h-10 rounded-full bg-yellow-400 border-2 border-transparent hover:border-white shadow-md transform hover:scale-110 active:scale-95 transition" onclick="setPenColor('#facc15')" title="é»ƒç­†"></button>
                <button class="w-10 h-10 rounded-full bg-blue-500 border-2 border-transparent hover:border-white shadow-md transform hover:scale-110 active:scale-95 transition" onclick="setPenColor('#3b82f6')" title="è—ç­†"></button>
                <button class="w-10 h-10 rounded-full bg-white border-2 border-transparent hover:border-gray-300 shadow-md transform hover:scale-110 active:scale-95 transition" onclick="setPenColor('#ffffff')" title="ç™½ç­†"></button>
                <div class="w-px h-8 bg-gray-600 mx-2"></div>
                <button onclick="clearCanvas()" class="text-gray-300 hover:text-red-400 w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-800 transition" title="æ¸…é™¤ç•«å¸ƒ">
                    <i class="fa-solid fa-eraser text-xl"></i>
                </button>
            </div>
            <!-- æ”¶åˆ/å±•é–‹æŒ‰éˆ• -->
            <button onclick="toggleToolbar()" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 shadow-md transition">
                <i id="toolbar-icon" class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- å…¨è¢å¹•ç€è¦½ Modal (Lightbox) -->
    <div id="fullscreen-modal" class="fixed inset-0 bg-black z-[90] hidden flex items-center justify-center cursor-zoom-out" onclick="closeFullscreen()">
        <img id="fullscreen-image" src="" class="max-w-full max-h-full object-contain" alt="Full Screen View">
        <button class="absolute top-4 right-4 text-white text-4xl opacity-70 hover:opacity-100 p-2">
            &times;
        </button>
    </div>

    <!-- è¨­å®š Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-6 relative border-4 border-kids-blue">
            <button onclick="closeSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <h2 class="text-2xl font-bold text-kids-blue mb-4 flex items-center">
                <i class="fa-solid fa-gear mr-2"></i> ç³»çµ±è¨­å®š
            </h2>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">GAS Web App URL (Script ID)</label>
                <div class="relative">
                    <input type="password" id="gas-url-input" class="shadow appearance-none border rounded-xl w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-kids-blue" placeholder="è«‹è²¼ä¸Š https://script.google.com/...">
                    <button onclick="toggleVisibility()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">ç¶²å€å°‡æœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒå¤–æµã€‚</p>
            </div>

            <!-- æ–°å¢ï¼šç¶²é æ¨™é¡Œè¨­å®š -->
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">ç¶²é æ¨™é¡Œ (App Title)</label>
                <input type="text" id="app-title-input" class="shadow appearance-none border rounded-xl w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-kids-blue" placeholder="ä¾‹å¦‚ï¼šå¿«æ¨‚å°å­¸å ‚ç›¸ç°¿">
            </div>

            <!-- åˆ†äº«å€å¡Š (æ›´æ–°) -->
            <div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <h3 class="font-bold text-gray-700 mb-2">ğŸ“¤ åˆ†äº«æ­¤ç›¸ç°¿ App</h3>
                <button onclick="generateShareLink()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition mb-3">
                    <i class="fa-solid fa-qrcode mr-2"></i> ç”¢ç”Ÿåˆ†äº«é€£çµèˆ‡ QR Code
                </button>
                
                <div id="share-result" class="hidden text-center space-y-3">
                    <!-- QR Code -->
                    <img id="qr-code-img" class="mx-auto border-4 border-white shadow-md rounded-lg" width="150" src="" alt="QR Code">
                    
                    <!-- åŸå§‹é€£çµé¡¯ç¤ºå€ -->
                    <div class="text-left">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">å°ˆç”¨é€£çµ (Original Link)</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="share-url-output" readonly class="flex-1 bg-white border text-sm p-2 rounded text-gray-600 focus:outline-none focus:ring-2 focus:ring-kids-blue">
                            <button onclick="copyShareUrl()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 p-2 rounded transition" title="è¤‡è£½é€£çµ"><i class="fa-solid fa-copy"></i></button>
                            <a id="open-share-link" href="#" target="_blank" class="bg-kids-blue hover:bg-blue-600 text-white p-2 rounded transition flex items-center justify-center" title="ç›´æ¥é–‹å•Ÿ"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end">
                <button onclick="saveSettings()" class="bg-kids-blue hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition transform hover:scale-105">
                    å„²å­˜ä¸¦é€£ç·š
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸Šå‚³ Modal -->
    <div id="upload-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-6 relative border-4 border-kids-green">
            <button onclick="closeUploadModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-kids-green mb-4">
                <i class="fa-solid fa-cloud-arrow-up mr-2"></i> ä¸Šå‚³æ–°ç…§ç‰‡
            </h2>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">ç›¸ç°¿åç¨± (å»ºç«‹æˆ–é¸æ“‡)</label>
                <input type="text" id="upload-album-name" list="album-options" class="shadow border rounded-xl w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-kids-green" placeholder="ä¾‹å¦‚ï¼šé‹å‹•æœƒ">
                <datalist id="album-options">
                    <!-- JS å‹•æ…‹å¡«å…¥ -->
                </datalist>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">é¸æ“‡åœ–ç‰‡</label>
                <input type="file" id="file-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-kids-green file:text-white hover:file:bg-green-600"/>
            </div>

            <!-- Canvas ç”¨æ–¼å£“ç¸®ï¼Œéš±è— -->
            <canvas id="compress-canvas" style="display:none;"></canvas>

            <button onclick="processAndUpload()" id="upload-btn" class="w-full bg-kids-green hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition">
                é–‹å§‹ä¸Šå‚³
            </button>
        </div>
    </div>

    <!-- èªªæ˜ Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full p-6 relative border-4 border-kids-red h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-kids-red">
                    <i class="fa-solid fa-book-open mr-2"></i> ä½¿ç”¨èªªæ˜èˆ‡ç¨‹å¼ç¢¼
                </h2>
                <button onclick="closeHelp()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="flex-1 overflow-y-auto bg-gray-50 p-4 rounded-xl border text-sm">
                <h3 class="font-bold text-lg mb-2">1. éƒ¨ç½²æ­¥é©Ÿ</h3>
                <ul class="list-disc list-inside mb-4 space-y-1 text-gray-600">
                    <li>å»ºç«‹ä¸€å€‹æ–°çš„ Google Sheetã€‚</li>
                    <li class="font-bold text-red-500">é‡è¦ï¼šè«‹å°‡è©¦ç®—è¡¨æ‰€åœ¨çš„ Google Drive è³‡æ–™å¤¾è¨­å®šå…±ç”¨ï¼Œæ¬Šé™è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººã€çš†å¯ã€Œæª¢è¦–ã€ã€‚</li>
                    <li>é»æ“Šã€Œæ“´å……åŠŸèƒ½ã€ > ã€ŒApps Scriptã€ã€‚</li>
                    <li>å°‡ä¸‹æ–¹ç¨‹å¼ç¢¼å®Œå…¨è¦†è“‹åˆ°ç·¨è¼¯å™¨ä¸­ã€‚</li>
                    <li>é»æ“Šã€Œéƒ¨ç½²ã€ > ã€Œæ–°å¢éƒ¨ç½²ã€ > é¡å‹é¸ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                    <li><b>èª°å¯ä»¥å­˜å–ï¼šå‹™å¿…é¸æ“‡ã€Œä»»ä½•äººã€</b>ã€‚</li>
                    <li>è¤‡è£½å¾—åˆ°çš„ç¶²å€ï¼Œè²¼åˆ°æœ¬ç¶²é çš„è¨­å®šä¸­ã€‚</li>
                </ul>

                <div class="flex justify-between items-end mb-2">
                    <h3 class="font-bold text-lg">2. GAS ç¨‹å¼ç¢¼</h3>
                    <button onclick="copyCode()" class="bg-gray-700 hover:bg-gray-900 text-white text-xs py-1 px-3 rounded flex items-center">
                        <i class="fa-solid fa-copy mr-1"></i> è¤‡è£½ç¨‹å¼ç¢¼
                    </button>
                </div>
                <pre id="code-block" class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-xs font-mono">
// ç¨‹å¼ç¢¼å°‡ç”± JS è‡ªå‹•å¡«å…¥ï¼Œè«‹è¦‹ä¸‹æ–¹çš„ codeString
                </pre>
            </div>
        </div>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let gasUrl = localStorage.getItem('gas_app_url') || "";
        let appTitle = localStorage.getItem('app_title') || "å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿"; // æ–°å¢ï¼šå…¨åŸŸæ¨™é¡Œè®Šæ•¸
        let albumsData = [];
        
        // --- Gallery æ’­æ”¾ç‹€æ…‹è®Šæ•¸ ---
        let currentAlbumPhotos = [];
        let currentPhotoIndex = 0;
        let playInterval = null;

        // --- ç°¡å ±æ¨¡å¼è®Šæ•¸ ---
        let isDrawing = false;
        let presentationCtx = null;
        let currentPenColor = '#ef4444'; // é è¨­ç´…è‰²
        let isToolbarExpanded = true;

        // é å­˜çš„ GAS ç¨‹å¼ç¢¼å­—ä¸²ï¼Œç”¨æ–¼ã€Œèªªæ˜ã€è¦–çª—é¡¯ç¤º
        const gasCodeString = `/**
 * å¿«æ¨‚å°å­¸å ‚ãƒ»é›²ç«¯ç›¸ç°¿ - å¾Œç«¯ API (ä¿®æ­£ç‰ˆ)
 */

const DB_SHEET_NAME = "ç›¸ç‰‡ä¸Šå‚³ç´€éŒ„";
const DB_HEADERS = ["æ™‚é–“æˆ³è¨˜", "ç›¸ç°¿åç¨± (è³‡æ–™å¤¾)", "æª”æ¡ˆåç¨±", "æª”æ¡ˆé¡å‹", "æª”æ¡ˆ ID", "é è¦½é€£çµ"];

function doGet(e) {
  const params = e.parameter;
  const action = params.action;
  let result = {};

  try {
    if (action === "getAlbums") {
      result = getAlbumData();
    } else if (action === "shortenUrl") {
      result = proxyShortenUrl(params.longUrl);
    } else {
      result = { status: "error", message: "æœªçŸ¥çš„è«‹æ±‚å‹•ä½œ" };
    }
  } catch (err) {
    result = { status: "error", message: err.toString() };
  }

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  let result = {};
  try {
    initDatabase();
    const postData = JSON.parse(e.postData.contents);
    const albumName = postData.albumName; 
    const fileName = postData.fileName;
    const base64Data = postData.image;

    const rootFolder = getRootFolder();
    let albumFolder;
    const folders = rootFolder.getFoldersByName(albumName);
    if (folders.hasNext()) {
      albumFolder = folders.next();
    } else {
      albumFolder = rootFolder.createFolder(albumName);
    }

    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.substring(base64Data.indexOf(',') + 1));
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = albumFolder.createFile(blob);
    
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(DB_SHEET_NAME);
    // ä½¿ç”¨å»ºæ§‹çš„ URL
    const fileUrl = "https://lh3.googleusercontent.com/d/" + file.getId() + "=s800";

    sheet.appendRow([new Date(), albumName, fileName, contentType, file.getId(), fileUrl]);
    result = { status: "success", message: "ä¸Šå‚³æˆåŠŸ", fileUrl: fileUrl };
  } catch (err) {
    result = { status: "error", message: err.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function getAlbumData() {
  const rootFolder = getRootFolder();
  const albums = [];
  const subFolders = rootFolder.getFolders();
  
  while (subFolders.hasNext()) {
    const folder = subFolders.next();
    const folderName = folder.getName();
    const folderId = folder.getId();
    const photos = [];
    const files = folder.getFiles();
    
    while (files.hasNext()) {
      const file = files.next();
      const mimeType = file.getMimeType();
      
      if (mimeType.startsWith('image/') || mimeType.startsWith('video/')) {
        // ä¿®æ­£ï¼šæ‰‹å‹•å»ºæ§‹é è¦½åœ– URLï¼Œè§£æ±º getThumbnailLink éŒ¯èª¤
        // lh3.googleusercontent.com/d/{ID}=s800 å¯ä»¥å–å¾—å¯¬åº¦ 800px çš„ç¸®åœ–
        const url = "https://lh3.googleusercontent.com/d/" + file.getId() + "=s800";

        photos.push({
          id: file.getId(),
          name: file.getName(),
          type: mimeType,
          url: url, 
          downloadUrl: file.getDownloadUrl()
        });
      }
    }
    
    if (photos.length > 0) {
      albums.push({
        id: folderId,
        name: folderName,
        cover: photos[0].url,
        photos: photos
      });
    }
  }
  return { status: "success", data: albums };
}

function getRootFolder() {
  const ssId = SpreadsheetApp.getActiveSpreadsheet().getId();
  const file = DriveApp.getFileById(ssId);
  const parents = file.getParents();
  if (parents.hasNext()) {
    return parents.next();
  } else {
    throw new Error("æ‰¾ä¸åˆ°è©¦ç®—è¡¨æ‰€åœ¨çš„çˆ¶è³‡æ–™å¤¾");
  }
}

function initDatabase() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(DB_SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(DB_SHEET_NAME);
    sheet.appendRow(DB_HEADERS);
  }
}

function proxyShortenUrl(longUrl) {
  if (!longUrl) return { status: "error", message: "ç„¡æ•ˆçš„ç¶²å€" };
  const apiUrl = \`https://is.gd/create.php?format=json&url=\${encodeURIComponent(longUrl)}\`;
  try {
    const response = UrlFetchApp.fetch(apiUrl, { muteHttpExceptions: true });
    const json = JSON.parse(response.getContentText());
    if (json.shorturl) {
      return { status: "success", shortUrl: json.shorturl };
    } else {
      return { status: "error", message: "ç¸®ç¶²å€å¤±æ•—", details: json };
    }
  } catch (e) {
    return { status: "error", message: "API é€£ç·šå¤±æ•—", error: e.toString() };
  }
}`; 

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            // å¡«å…¥ç¨‹å¼ç¢¼é¡¯ç¤ºå€
            document.getElementById('code-block').innerText = gasCodeString;

            const urlParams = new URLSearchParams(window.location.search);
            
            // å„ªå…ˆè™•ç† Title (è‹¥ç¶²å€æœ‰åƒæ•¸)
            const paramTitle = urlParams.get('title');
            if (paramTitle) {
                appTitle = decodeURIComponent(paramTitle);
                // ä¹Ÿå¯ä»¥é¸æ“‡æ˜¯å¦å°‡ç¶²å€åƒæ•¸çš„æ¨™é¡Œå­˜å›æœ¬åœ°ï¼Œé€™è£¡é¸æ“‡å­˜å…¥ï¼Œæ–¹ä¾¿ä¸‹æ¬¡é–‹å•Ÿ
                localStorage.setItem('app_title', appTitle);
            }
            updateAppTitleUI(appTitle);

            // è™•ç† Config (GAS URL)
            const config = urlParams.get('config');
            if (config) {
                try {
                    const decodedUrl = atob(config); // Base64 Decode
                    if (decodedUrl.startsWith('http')) {
                        gasUrl = decodedUrl;
                        localStorage.setItem('gas_app_url', gasUrl);
                        // æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œä½†ä¿ç•™æ¨™é¡Œåœ¨ä»‹é¢ä¸Š
                        window.history.replaceState({}, document.title, window.location.pathname);
                        Swal.fire({
                            icon: 'success',
                            title: 'é€£ç·šæˆåŠŸï¼',
                            text: 'å·²è‡ªå‹•è¼‰å…¥ç›¸ç°¿è¨­å®š',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                } catch (e) {
                    console.error("Config decode failed", e);
                }
            }

            // åˆå§‹åŒ–è¨­å®šä»‹é¢çš„å€¼
            document.getElementById('app-title-input').value = appTitle;
            if (gasUrl) {
                document.getElementById('gas-url-input').value = gasUrl;
                fetchAlbums();
            } else {
                document.getElementById('empty-state').classList.remove('hidden');
            }

            // åˆå§‹åŒ–ç°¡å ±ç•«å¸ƒç›£è½
            initPresentationCanvas();
        };

        // --- è¼”åŠ©å‡½å¼ï¼šæ›´æ–°ä»‹é¢æ¨™é¡Œ ---
        function updateAppTitleUI(title) {
            document.title = title + " ğŸ“¸";
            document.getElementById('app-header-title').innerText = title;
        }

        // --- API æ ¸å¿ƒåŠŸèƒ½ ---

        async function fetchAlbums() {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const albumGrid = document.getElementById('album-grid');

            loading.classList.remove('hidden');
            emptyState.classList.add('hidden');
            albumGrid.innerHTML = ''; // æ¸…ç©º

            try {
                // ä½¿ç”¨ fetch å‘¼å« GAS GET
                const response = await fetch(`${gasUrl}?action=getAlbums`);
                const json = await response.json();

                if (json.status === 'success') {
                    albumsData = json.data;
                    renderAlbums(albumsData);
                    updateUploadOptions(albumsData); // æ›´æ–°ä¸Šå‚³é¸å–®
                } else {
                    throw new Error(json.message || "æœªçŸ¥éŒ¯èª¤");
                }
            } catch (error) {
                console.error(error);
                Swal.fire('è®€å–å¤±æ•—', 'ç„¡æ³•é€£æ¥åˆ° GASï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–æ¬Šé™è¨­å®šã€‚', 'error');
                emptyState.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // --- æ¸²æŸ“ UI ---

        function renderAlbums(albums) {
            const grid = document.getElementById('album-grid');
            if (albums.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">è³‡æ–™å¤¾è£¡é‚„æ²’æœ‰ç…§ç‰‡å–”ï¼è¶•å¿«ä¸Šå‚³å§ï¼</div>`;
                return;
            }

            albums.forEach(album => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-lg overflow-hidden card-hover cursor-pointer group border-2 border-transparent hover:border-kids-yellow transition";
                card.onclick = () => openGallery(album.id);

                const coverImg = album.cover || 'https://via.placeholder.com/400x300?text=No+Image';

                card.innerHTML = `
                    <div class="relative h-48 overflow-hidden bg-gray-200">
                        <img src="${coverImg}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" loading="lazy" onerror="this.src='https://via.placeholder.com/400?text=Error'">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition"></div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg text-gray-800 truncate"><i class="fa-regular fa-folder-open mr-2 text-kids-yellow"></i>${album.name}</h3>
                        <p class="text-sm text-gray-500 mt-1">${album.photos.length} å¼µç…§ç‰‡</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- Gallery åŠŸèƒ½ ---

        function openGallery(albumId) {
            const album = albumsData.find(a => a.id === albumId);
            if (!album) return;

            currentAlbumPhotos = album.photos;
            currentPhotoIndex = 0;
            stopAutoPlay();

            document.getElementById('gallery-title').innerText = album.name;
            const thumbStrip = document.getElementById('thumbnail-strip');
            thumbStrip.innerHTML = '';

            currentAlbumPhotos.forEach((photo, index) => {
                const thumb = document.createElement('div');
                thumb.className = `w-16 h-16 md:w-20 md:h-20 shrink-0 cursor-pointer rounded-lg overflow-hidden opacity-60 hover:opacity-100 transition duration-200 border-2 border-transparent`;
                thumb.id = `thumb-${index}`;
                thumb.onclick = () => {
                    stopAutoPlay();
                    currentPhotoIndex = index;
                    updateMainPhoto();
                };

                let imgContent;
                if (photo.type.startsWith('video')) {
                    imgContent = `<div class="w-full h-full bg-gray-800 flex items-center justify-center text-white"><i class="fa-solid fa-video"></i></div>`;
                } else {
                    imgContent = `<img src="${photo.url}" class="w-full h-full object-cover">`;
                }
                
                thumb.innerHTML = imgContent;
                thumbStrip.appendChild(thumb);
            });

            updateMainPhoto();
            document.getElementById('gallery-modal').classList.remove('hidden');
        }

        function updateMainPhoto() {
            if (currentAlbumPhotos.length === 0) return;

            const photo = currentAlbumPhotos[currentPhotoIndex];
            const mainView = document.getElementById('main-view');

            let mediaEl;
            if (photo.type.startsWith('video')) {
                mediaEl = `<video src="${photo.downloadUrl}" controls autoplay class="max-w-full max-h-full object-contain shadow-2xl"></video>`;
            } else {
                mediaEl = `<img src="${photo.url}" onclick="openFullscreen('${photo.url}')" class="max-w-full max-h-full object-contain shadow-2xl animate-fade-in cursor-zoom-in" title="é»æ“Šæ”¾å¤§">`;
            }
            mainView.innerHTML = mediaEl;

            document.querySelectorAll('#thumbnail-strip > div').forEach(el => el.classList.remove('thumb-active'));
            const activeThumb = document.getElementById(`thumb-${currentPhotoIndex}`);
            if (activeThumb) {
                activeThumb.classList.add('thumb-active');
                activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function nextPhoto() {
            currentPhotoIndex = (currentPhotoIndex + 1) % currentAlbumPhotos.length;
            updateMainPhoto();
            
            // å¦‚æœç°¡å ±æ¨¡å¼é–‹å•Ÿï¼ŒåŒæ­¥æ›´æ–°
            if (!document.getElementById('presentation-modal').classList.contains('hidden')) {
                updatePresentationImage();
                clearCanvas(); // æ›é æ¸…ç©ºç•«ç­†
            }
        }

        function prevPhoto() {
            currentPhotoIndex = (currentPhotoIndex - 1 + currentAlbumPhotos.length) % currentAlbumPhotos.length;
            updateMainPhoto();
            
            // å¦‚æœç°¡å ±æ¨¡å¼é–‹å•Ÿï¼ŒåŒæ­¥æ›´æ–°
            if (!document.getElementById('presentation-modal').classList.contains('hidden')) {
                updatePresentationImage();
                clearCanvas(); // æ›é æ¸…ç©ºç•«ç­†
            }
        }

        function toggleAutoPlay() {
            const btn = document.getElementById('auto-play-btn');
            if (playInterval) {
                stopAutoPlay();
            } else {
                playInterval = setInterval(nextPhoto, 3000);
                btn.innerHTML = `<i class="fa-solid fa-pause"></i> <span class="hidden md:inline">æš«åœæ’­æ”¾</span>`;
                btn.classList.add('bg-kids-yellow', 'text-gray-900');
                btn.classList.remove('bg-gray-700', 'text-white');
            }
        }

        function stopAutoPlay() {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
                const btn = document.getElementById('auto-play-btn');
                btn.innerHTML = `<i class="fa-solid fa-play"></i> <span class="hidden md:inline">è‡ªå‹•æ’­æ”¾</span>`;
                btn.classList.remove('bg-kids-yellow', 'text-gray-900');
                btn.classList.add('bg-gray-700', 'text-white');
            }
        }

        // --- ç°¡å ±æ¨¡å¼é‚è¼¯ (æ–°åŠŸèƒ½) ---

        function openPresentationMode() {
            stopAutoPlay(); // é€²å…¥ç°¡å ±æ™‚æš«åœè‡ªå‹•æ’­æ”¾
            const modal = document.getElementById('presentation-modal');
            modal.classList.remove('hidden');
            
            // è¨­å®š Canvas å¤§å°
            const canvas = document.getElementById('drawing-canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            presentationCtx = canvas.getContext('2d');
            
            // ç›£è½è¦–çª—å¤§å°æ”¹è®Š
            window.addEventListener('resize', resizePresentationCanvas);
            
            // æ–°å¢ï¼šç›£è½éµç›¤äº‹ä»¶
            window.addEventListener('keydown', handlePresentationKeydown);

            // åˆ‡æ›æˆä¸‹ä¸€å¼µ (ç°¡å ±å…§çš„å°èˆªé‚è¼¯ï¼šå…±ç”¨ prevPhoto/nextPhoto)
            // è¼‰å…¥ç•¶å‰åœ–ç‰‡
            updatePresentationImage();
            clearCanvas();
        }

        function closePresentationMode() {
            document.getElementById('presentation-modal').classList.add('hidden');
            window.removeEventListener('resize', resizePresentationCanvas);
            
            // æ–°å¢ï¼šç§»é™¤éµç›¤äº‹ä»¶ç›£è½
            window.removeEventListener('keydown', handlePresentationKeydown);
        }

        // æ–°å¢ï¼šè™•ç†éµç›¤æŒ‰éµ
        function handlePresentationKeydown(e) {
            if (document.getElementById('presentation-modal').classList.contains('hidden')) return;

            if (e.key === 'ArrowRight') {
                nextSlide();
            } else if (e.key === 'ArrowLeft') {
                prevSlide();
            } else if (e.key === 'Escape') {
                closePresentationMode();
            }
        }

        function resizePresentationCanvas() {
            const canvas = document.getElementById('drawing-canvas');
            // ä¿å­˜ç•¶å‰å…§å®¹å¤ªè¤‡é›œï¼Œç°¡å–®ç­–ç•¥æ˜¯ç›´æ¥æ¸…ç©ºæˆ–é‡è¨­å¤§å°
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            clearCanvas(); 
        }

        function updatePresentationImage() {
            const photo = currentAlbumPhotos[currentPhotoIndex];
            const img = document.getElementById('presentation-image');
            
            // ç°¡å ±æ¨¡å¼ç›®å‰åƒ…æ”¯æ´åœ–ç‰‡ç¹ªåœ–ï¼Œè‹¥æ˜¯å½±ç‰‡é¡¯ç¤ºç¸®åœ–æˆ–æç¤º
            if (photo.type.startsWith('video')) {
               // æš«æ™‚ç”¨å½±ç‰‡å°é¢æˆ–é è¨­åœ–
               img.src = 'https://via.placeholder.com/1920x1080?text=Video+File+(Drawing+Disabled)';
            } else {
               img.src = photo.url; // å»ºè­°ä½¿ç”¨å¤§åœ– (photo.downloadUrl) ä½†ç‚ºäº†é€Ÿåº¦ç”¨ url
            }
        }

        // ç°¡å ±å°èˆª (åŒ…è£åŸæœ‰åŠŸèƒ½ï¼Œå¢åŠ æ¸…ç©ºç•«ç­†)
        function nextSlide() { nextPhoto(); }
        function prevSlide() { prevPhoto(); }

        // --- ç•«ç­†åŠŸèƒ½é‚è¼¯ ---

        function initPresentationCanvas() {
            const canvas = document.getElementById('drawing-canvas');
            
            const startDraw = (e) => {
                isDrawing = true;
                presentationCtx.beginPath();
                const { x, y } = getEventPos(e);
                presentationCtx.moveTo(x, y);
                // è¨­å®šç•«ç­†æ¨£å¼
                presentationCtx.strokeStyle = currentPenColor;
                presentationCtx.lineWidth = 5;
                presentationCtx.lineCap = 'round';
                presentationCtx.lineJoin = 'round';
            };

            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿæ²å‹•
                const { x, y } = getEventPos(e);
                presentationCtx.lineTo(x, y);
                presentationCtx.stroke();
            };

            const endDraw = () => {
                isDrawing = false;
                presentationCtx.closePath();
            };

            // æ»‘é¼ äº‹ä»¶
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseout', endDraw);

            // è§¸æ§äº‹ä»¶
            canvas.addEventListener('touchstart', startDraw, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', endDraw);
        }

        function getEventPos(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            } else {
                return { x: e.clientX, y: e.clientY };
            }
        }

        function setPenColor(color) {
            currentPenColor = color;
            // æ›´æ–° UI ç‹€æ…‹ (é¸ä¸­æ•ˆæœ)
            const buttons = document.querySelectorAll('#drawing-tools button');
            buttons.forEach(btn => btn.style.transform = 'scale(1)');
            event.currentTarget.style.transform = 'scale(1.2)';
        }

        function clearCanvas() {
            const canvas = document.getElementById('drawing-canvas');
            if (presentationCtx) {
                presentationCtx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function toggleToolbar() {
            const tools = document.getElementById('drawing-tools');
            const icon = document.getElementById('toolbar-icon');
            
            if (isToolbarExpanded) {
                tools.style.width = '0px';
                tools.style.padding = '0px';
                tools.style.opacity = '0';
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left'); // ä»£è¡¨å¯ä»¥å±•é–‹
            } else {
                tools.style.width = 'auto'; // æˆ–å…·é«”æ•¸å€¼
                tools.style.padding = '0 0.5rem'; // æ¢å¾© padding
                tools.style.opacity = '1';
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            }
            isToolbarExpanded = !isToolbarExpanded;
        }


        // --- å…¨è¢å¹•ç€è¦½åŠŸèƒ½ (Lightbox) ---
        function openFullscreen(src) {
            const modal = document.getElementById('fullscreen-modal');
            const img = document.getElementById('fullscreen-image');
            img.src = src;
            modal.classList.remove('hidden');
            stopAutoPlay();
        }

        function closeFullscreen() {
            document.getElementById('fullscreen-modal').classList.add('hidden');
        }

        // --- æ‰“åŒ…ä¸‹è¼‰ (ZIP) åŠŸèƒ½ ---
        async function downloadAlbumZip() {
            if (currentAlbumPhotos.length === 0) return;

            const albumName = document.getElementById('gallery-title').innerText;
            
            const result = await Swal.fire({
                title: 'æº–å‚™ä¸‹è¼‰',
                text: `å³å°‡æ‰“åŒ…ä¸‹è¼‰ã€Œ${albumName}ã€ç›¸ç°¿ä¸­çš„ ${currentAlbumPhotos.length} å¼µç…§ç‰‡ï¼Œå¯èƒ½éœ€è¦ä¸€é»æ™‚é–“ã€‚`,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'é–‹å§‹ä¸‹è¼‰',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#4D96FF'
            });

            if (!result.isConfirmed) return;

            const zip = new JSZip();
            const folder = zip.folder(albumName);

            let progressPopup = Swal.fire({
                title: 'æ‰“åŒ…ä¸­...',
                html: 'æ­£åœ¨ä¸‹è¼‰ç…§ç‰‡ï¼š<b>0%</b>',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            let completedCount = 0;
            const total = currentAlbumPhotos.length;

            try {
                const downloadPromises = currentAlbumPhotos.map(async (photo, index) => {
                    try {
                        const response = await fetch(photo.url, { mode: 'cors' });
                        if (!response.ok) throw new Error('Network error');
                        const blob = await response.blob();
                        
                        let ext = 'jpg';
                        if (photo.type.includes('png')) ext = 'png';
                        if (photo.type.includes('gif')) ext = 'gif';
                        
                        folder.file(`${albumName}_${index + 1}.${ext}`, blob);

                    } catch (err) {
                        console.error(`Failed to load photo ${index}`, err);
                        folder.file(`error_${index + 1}.txt`, `Failed to download: ${photo.url}`);
                    } finally {
                        completedCount++;
                        const percent = Math.round((completedCount / total) * 100);
                        if (Swal.getHtmlContainer()) {
                            Swal.getHtmlContainer().querySelector('b').textContent = `${percent}%`;
                        }
                    }
                });

                await Promise.all(downloadPromises);

                if (Swal.getHtmlContainer()) Swal.getHtmlContainer().innerHTML = 'æ­£åœ¨å£“ç¸®æª”æ¡ˆ...';
                
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `${albumName}.zip`);

                Swal.fire('ä¸‹è¼‰å®Œæˆ', 'ç›¸ç°¿å·²æ‰“åŒ…ä¸‹è¼‰ï¼', 'success');

            } catch (error) {
                console.error(error);
                Swal.fire('ä¸‹è¼‰å¤±æ•—', 'æ‰“åŒ…éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }


        // --- ä¸Šå‚³åŠŸèƒ½ (å« Canvas å£“ç¸®) ---

        function updateUploadOptions(albums) {
            const datalist = document.getElementById('album-options');
            datalist.innerHTML = '';
            albums.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.name;
                datalist.appendChild(opt);
            });
        }

        async function processAndUpload() {
            const albumName = document.getElementById('upload-album-name').value;
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if (!gasUrl) return Swal.fire('éŒ¯èª¤', 'è«‹å…ˆè¨­å®š GAS ç¶²å€', 'warning');
            if (!albumName) return Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥ç›¸ç°¿åç¨±', 'warning');
            if (!file) return Swal.fire('éŒ¯èª¤', 'è«‹é¸æ“‡åœ–ç‰‡', 'warning');

            // UI Loading ç‹€æ…‹
            const btn = document.getElementById('upload-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> è™•ç†ä¸­...`;

            try {
                // 1. å£“ç¸®åœ–ç‰‡
                const base64 = await compressImage(file);

                // 2. ç™¼é€ POST è«‹æ±‚
                const payload = {
                    albumName: albumName,
                    fileName: file.name,
                    image: base64
                };

                // ä½¿ç”¨ fetch POSTï¼Œæ³¨æ„ mode: 'no-cors' åœ¨ GAS æœƒæœ‰å›å‚³å€¼è®€å–é™åˆ¶
                // ä½†ç‚ºäº†è®€å–å›å‚³çµæœï¼Œé€šå¸¸ä½¿ç”¨ redirect: 'follow' é…åˆ GAS çš„ ContentService
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                const json = await response.json();

                if (json.status === 'success') {
                    Swal.fire('æˆåŠŸ', 'ç…§ç‰‡å·²ä¸Šå‚³ï¼', 'success');
                    closeUploadModal();
                    fetchAlbums(); // é‡æ–°æ•´ç†
                } else {
                    throw new Error(json.message);
                }

            } catch (error) {
                console.error(error);
                Swal.fire('ä¸Šå‚³å¤±æ•—', 'è«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS éƒ¨ç½²è¨­å®š', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.getElementById('compress-canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // è¨ˆç®—ç­‰æ¯”ä¾‹ç¸®æ”¾
                        const maxWidth = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        // è½‰ç‚º Base64 (JPEG, å“è³ª 0.8)
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // --- è¨­å®šèˆ‡åˆ†äº«åŠŸèƒ½ ---

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function toggleVisibility() {
            const input = document.getElementById('gas-url-input');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        function saveSettings() {
            const url = document.getElementById('gas-url-input').value.trim();
            if(!url.startsWith("https://script.google.com/")) {
                Swal.fire('æ ¼å¼éŒ¯èª¤', 'è«‹è¼¸å…¥æ­£ç¢ºçš„ Google Apps Script ç¶²å€', 'error');
                return;
            }
            
            // å„²å­˜ GAS URL
            localStorage.setItem('gas_app_url', url);
            gasUrl = url;

            // å„²å­˜ App Title
            const newTitle = document.getElementById('app-title-input').value.trim() || "å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿";
            localStorage.setItem('app_title', newTitle);
            appTitle = newTitle;
            updateAppTitleUI(newTitle);

            closeSettings();
            fetchAlbums();
            Swal.fire('å·²å„²å­˜', 'è¨­å®šå·²æ›´æ–°ä¸¦å˜—è©¦é€£ç·š', 'success');
        }

        async function generateShareLink() {
            if (!gasUrl) { Swal.fire('è«‹å…ˆå„²å­˜ GAS ç¶²å€'); return; }

            // 1. å»ºç«‹å¸¶åƒæ•¸çš„é•·ç¶²å€
            const baseUrl = window.location.href.split('?')[0];
            const encodedGas = btoa(gasUrl);
            // ç·¨ç¢¼æ¨™é¡Œ
            const encodedTitle = encodeURIComponent(appTitle);
            // çµ„åˆåƒæ•¸ï¼šconfig (GAS) + title (æ¨™é¡Œ)
            const longUrl = `${baseUrl}?config=${encodedGas}&title=${encodedTitle}`;

            // é¡¯ç¤ºåŸå§‹é€£çµ
            document.getElementById('share-url-output').value = longUrl;
            document.getElementById('open-share-link').href = longUrl;
            
            // é¡¯ç¤º UI ä¸¦é€²å…¥ Loading ç‹€æ…‹ (QR Code)
            document.getElementById('qr-code-img').src = 'https://via.placeholder.com/150?text=Generating...';
            document.getElementById('share-result').classList.remove('hidden');

            // 2. å‘¼å« GAS å¾Œç«¯ä»£ç†ç¸®ç¶²å€ (åƒ…ç”¨æ–¼ QR Code å„ªåŒ–ï¼Œé¿å…å¤ªå¯†)
            try {
                const response = await fetch(`${gasUrl}?action=shortenUrl&longUrl=${encodeURIComponent(longUrl)}`);
                const json = await response.json();
                
                let qrTargetUrl = longUrl;
                if (json.status === 'success') {
                    qrTargetUrl = json.shortUrl;
                } else {
                    console.warn("ç¸®ç¶²å€å¤±æ•—ï¼ŒQR Code ä½¿ç”¨é•·ç¶²å€", json);
                }

                // 3. ç”Ÿæˆ QR Code
                const qrUrl = `https://quickchart.io/qr?text=${encodeURIComponent(qrTargetUrl)}&size=200&margin=2`;
                document.getElementById('qr-code-img').src = qrUrl;

            } catch (e) {
                console.error(e);
                // å¤±æ•—æ™‚ QR Code ä½¿ç”¨é•·ç¶²å€ fallback
                const qrUrl = `https://quickchart.io/qr?text=${encodeURIComponent(longUrl)}&size=200&margin=2`;
                document.getElementById('qr-code-img').src = qrUrl;
            }
        }

        function copyShareUrl() {
            const copyText = document.getElementById("share-url-output");
            copyText.select();
            
            // å˜—è©¦ä½¿ç”¨ç¾ä»£ API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(copyText.value).then(() => {
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'é€£çµå·²è¤‡è£½', showConfirmButton: false, timer: 1500 });
                }).catch(() => {
                    document.execCommand("copy"); // Fallback
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'é€£çµå·²è¤‡è£½', showConfirmButton: false, timer: 1500 });
                });
            } else {
                document.execCommand("copy");
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'é€£çµå·²è¤‡è£½', showConfirmButton: false, timer: 1500 });
            }
        }

        // --- èªªæ˜è¦–çª—åŠŸèƒ½ ---
        function openHelp() { document.getElementById('help-modal').classList.remove('hidden'); }
        function closeHelp() { document.getElementById('help-modal').classList.add('hidden'); }
        function copyCode() {
            // é€™è£¡ç‚ºäº†ç¯„ä¾‹ç°¡å–®ï¼Œå¯¦éš›æ‡‰è©²è¤‡è£½ Code.gs çš„å…§å®¹
            navigator.clipboard.writeText(document.getElementById('code-block').innerText)
                .then(() => Swal.fire('è¤‡è£½æˆåŠŸ', 'ç¨‹å¼ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success'));
        }

        // --- å…¶ä»– Modal æ§åˆ¶ ---
        function closeGallery() { 
            stopAutoPlay(); // é—œé–‰è¦–çª—æ™‚åœæ­¢æ’­æ”¾
            document.getElementById('gallery-modal').classList.add('hidden'); 
            document.getElementById('main-view').innerHTML = ''; // æ¸…ç©ºå…§å®¹é¿å…å½±ç‰‡ç¹¼çºŒåœ¨èƒŒæ™¯æ’­æ”¾
        }
        function openUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); }
        function closeUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }

    </script>
</body>
</html>